<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI è™šæ‹Ÿé¢è¯•å®˜</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; background: #f4f4f7; }
        #chat-window { height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; background: white; margin-bottom: 20px; }
        .msg { margin: 10px 0; padding: 8px; border-radius: 5px; }
        .user { background: #e3f2fd; text-align: right; }
        .ai { background: #f1f8e9; text-align: left; }
        #record-btn { width: 100%; padding: 15px; font-size: 18px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        #record-btn:active { background: #0056b3; }
        .status { color: gray; font-size: 12px; text-align: center; }
        #input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #text-input {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: none; /* ç¦æ­¢æ‰‹åŠ¨æ‹‰ä¼¸ */
            font-family: inherit;
            box-sizing: border-box;
        }

        .control-row {
            display: flex;
            gap: 10px;
        }

        #record-btn {
            flex: 2; /* å½•éŸ³æŒ‰é’®å å¤§éƒ¨åˆ†ç©ºé—´ */
            background: #28a745;
        }

        #send-txt-btn {
            flex: 1; /* å‘é€æŒ‰é’®å è¾ƒå°ç©ºé—´ */
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #send-txt-btn:hover {
            background: #0056b3;
        }

        #send-txt-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .mode-selector { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; background: #eee; padding: 10px; border-radius: 8px; }
        /* å¼€å…³åŸºç¡€æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
<h2>ğŸ’» AI è™šæ‹Ÿé¢è¯•å®˜ (è®¡ç®—æœºä¸“ä¸š)</h2>
<div class="mode-selector">
    <span>å½“å‰æ¨¡å¼ï¼š</span>
    <label class="switch">
        <input type="checkbox" id="mode-toggle" checked>
        <span class="slider round"></span>
    </label>
    <span id="mode-label">å¾®è°ƒæ¨¡å‹ (chat2)</span>
</div>
<div id="chat-window"></div>
<p class="status" id="status">å‡†å¤‡å°±ç»ª</p>
<!--<button id="record-btn">æŒ‰ä½è¯´è¯</button>-->
<div id="input-area">
    <textarea id="text-input" placeholder="è¾“å…¥ä½ çš„å›ç­”... (Shift + Enter æ¢è¡Œ)"></textarea>
    <div class="control-row">
        <button id="record-btn">æŒ‰ä½è¯´è¯</button>
        <button id="send-txt-btn">å‘é€æ–‡å­—</button>
    </div>
</div>


<script>
    let mediaRecorder;
    let audioChunks = [];
    let isCancelled = false;
    const btn = document.getElementById('record-btn');
    const statusText = document.getElementById('status');
    const chatWindow = document.getElementById('chat-window');

    // è·å–æ–°å¢çš„å…ƒç´ 
    const textInput = document.getElementById('text-input');
    const sendTxtBtn = document.getElementById('send-txt-btn');

    const modeToggle = document.getElementById('mode-toggle');
    const modeLabel = document.getElementById('mode-label');

    // --- çŠ¶æ€å˜é‡ ---
    let currentSessionId = generateSessionId(); // åˆå§‹åŒ–ç¬¬ä¸€ä¸ª SessionID

    // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆå”¯ä¸€çš„ Session ID
    function generateSessionId() {
        return "session_" + Math.random().toString(36).substring(2, 10) + "_" + Date.now();
    }

    // --- æ ¸å¿ƒåˆ‡æ¢é€»è¾‘ ---
    modeToggle.onchange = () => {
        // 1. æ›´æ–° UI æ ‡ç­¾
        const isFinetuned = modeToggle.checked;
        modeLabel.innerText = isFinetuned ? "å¾®è°ƒæ¨¡å‹ (chat2)" : "åŸå§‹æ¨¡å‹ (chat1)";

        // 2. æ¸…ç©ºèŠå¤©ç•Œé¢
        chatWindow.innerHTML = "";
        addMsg('ai', `æ­£åœ¨åˆ‡æ¢è‡³${isFinetuned ? 'å¾®è°ƒ' : 'åŸå§‹'}æ¨¡å‹å¹¶åˆ›å»ºæ–°ä¼šè¯...`);

        // 3. ç”Ÿæˆå…¨æ–°çš„ Session ID (å½»åº•å‘Šåˆ«æ—§è®°å¿†)
        currentSessionId = generateSessionId();
        console.log(">>> ä¼šè¯å·²é‡ç½®ï¼Œæ–° SessionID:", currentSessionId);

        // 4. è‡ªåŠ¨è§¦å‘æ–°æ¨¡å‹çš„å¼€åœºç™½ (START)
        sendToBackend(null, "START");
    };

    // --- æ–‡å­—è¾“å…¥é€»è¾‘ ---

    // ç‚¹å‡»æŒ‰é’®å‘é€
    sendTxtBtn.onclick = () => {
        handleTextSend();
    };

    // æŒ‰ä¸‹å›è½¦é”®å‘é€ (Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ)
    textInput.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„å›è½¦æ¢è¡Œ
            handleTextSend();
        }
    };

    async function handleTextSend() {
        const text = textInput.value.trim();
        if (!text) return;

        // ç¦ç”¨è¾“å…¥ï¼Œé˜²æ­¢é‡å¤å‘é€
        textInput.value = "";
        textInput.disabled = true;
        sendTxtBtn.disabled = true;

        document.getElementById('status').innerText = "é¢è¯•å®˜æ­£åœ¨æ€è€ƒ...";

        // è°ƒç”¨ä¹‹å‰å†™å¥½çš„åç«¯å‘é€å‡½æ•°
        // æ³¨æ„ï¼šç¬¬ä¸€ä¸ªå‚æ•°ä¼  nullï¼Œå› ä¸ºæ²¡æœ‰å½•éŸ³æ–‡ä»¶
        await sendToBackend(null, text);

        // æ¢å¤è¾“å…¥
        textInput.disabled = false;
        sendTxtBtn.disabled = false;
        textInput.focus();
    }


    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
            if (isCancelled) {
                console.log(">>> å½•éŸ³å·²å–æ¶ˆ");
                audioChunks = [];
                return;
            }
            const audioBlob = new Blob(audioChunks, { type: 'audio/m4a' });
            if (audioBlob.size > 0) sendToBackend(audioBlob);
            audioChunks = [];
        };
    });

    // 1. æŒ‰ä¸‹æŒ‰é’®ï¼šä»…ç”±æŒ‰é’®è§¦å‘
    btn.onmousedown = (e) => {
        e.preventDefault(); // é˜²æ­¢æŸäº›æµè§ˆå™¨ä¸‹çš„æ–‡å­—é€‰ä¸­å¹²æ‰°
        isCancelled = false;
        audioChunks = [];
        if (mediaRecorder.state === "inactive") {
            mediaRecorder.start();
            btn.style.background = "#28a745";
            btn.innerText = "æ­£åœ¨å½•éŸ³... (ç§»å‡ºæŒ‰é’®å–æ¶ˆ)";
            statusText.innerText = "å½•éŸ³ä¸­...";
        }
    };

    // 2. ç§»å‡ºæŒ‰é’®ï¼šä»…åšçŠ¶æ€æ ‡è®°å’Œ UI æç¤º
    btn.onmouseleave = () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            isCancelled = true;
            btn.style.background = "#dc3545";
            btn.innerText = "æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€";
            statusText.innerText = "âš  é‡Šæ”¾å³å–æ¶ˆ";
        }
    };

    // 3. ç§»å›æŒ‰é’®ï¼šæ¢å¤çŠ¶æ€
    btn.onmouseenter = () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            isCancelled = false;
            btn.style.background = "#28a745";
            btn.innerText = "æ­£åœ¨å½•éŸ³... (ç§»å‡ºæŒ‰é’®å–æ¶ˆ)";
            statusText.innerText = "ç»§ç»­å½•éŸ³...";
        }
    };

    // 4. ã€å…³é”®ä¿®å¤ã€‘åœ¨å…¨å±€ window ä¸Šç›‘å¬æ¾æ‰‹
    window.onmouseup = () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();

            // æ¢å¤ UI æ ·å¼
            btn.style.background = "#007bff";
            btn.innerText = "æŒ‰ä½è¯´è¯";

            if (isCancelled) {
                statusText.innerText = "å·²å–æ¶ˆå‘é€";
            } else {
                statusText.innerText = "å‘é€ä¸­ï¼Œè¯·ç¨å€™...";
            }
        }
    };

    const sessionId = "session_" + Math.random().toString(36).substring(7);

    // --- ä¿®æ”¹åŸæœ‰çš„ sendToBackend å‡½æ•°ä»¥æ”¯æŒç•Œé¢å±•ç¤º ---
    async function sendToBackend(blob, manualText = null) {
        const formData = new FormData();


        if (blob) {
            formData.append('file', blob, 'recording.m4a');
        }
        if (manualText) {
            formData.append('text', manualText);
        }

        // ğŸ‘ˆ åŠ¨æ€è·å–å½“å‰çš„æ¨¡å¼å’Œ SessionId
        const selectedMode = modeToggle.checked ? "finetuned" : "base";
        console.log(">>> [å‰ç«¯æ£€æŸ¥] å‡†å¤‡å‘é€çš„æ¨¡å¼ä¸º:", selectedMode); // ğŸ‘ˆ æ·»åŠ è¿™ä¸€è¡Œ
        formData.append('mode', selectedMode);
        formData.append('sessionId', currentSessionId);

        try {
            // å±•ç¤ºç”¨æˆ·å‘é€çš„æ–‡å­—ï¼ˆéåˆå§‹åŒ–æŒ‡ä»¤æ—¶ï¼‰
            if (manualText && manualText !== "START") {
                addMsg('user', manualText);
            }

            const response = await fetch('/api/interview', { method: 'POST', body: formData });
            const data = await response.json();

            // å±•ç¤ºè¯­éŸ³è½¬å†™ç»“æœ
            if (blob) {
                addMsg('user', data.userText);
            }

            // å±•ç¤º AI å›å¤
            addMsg('ai', data.aiText);

            // æ’­æ”¾è¯­éŸ³
            const audio = new Audio("data:audio/mpeg;base64," + data.audio);
            audio.play();

            document.getElementById('status').innerText = "å‡†å¤‡å°±ç»ª";
        } catch (error) {
            console.error("é€šä¿¡å¤±è´¥:", error);
            document.getElementById('status').innerText = "æœåŠ¡è¿æ¥å¼‚å¸¸";
        }
    }

    function addMsg(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
    window.onload = () => {
        addMsg('ai', "æ­£åœ¨åˆå§‹åŒ–é¢è¯•å®˜ï¼Œè¯·ç¨å€™...");
        // æ˜ç¡®è°ƒç”¨ sendToBackendï¼Œä¼ å…¥ START
        sendToBackend(null, "START");
    };
</script>
</body>
</html>